## Оконные функции

1. Ранжирующие
   - row_number	
   - rank
2. Агрегатные функции
   - min
   - max
   - avg
   - sum
   - count
3. Функции получения доступа
   - lag
   - lead

### Ранжирующие функции

| Pno  | Pname  | Color | Weight | r1   | r2    | r3   |
| ---- | ------ | ----- | ------ | ---- | ----- | ---- |
| 1    | Гвоздь | **К** | 14     | 5    | **2** | 2    |
| 2    | Гвоздь | **К** | 15     | 6    | **3** | 3    |
| 3    | Винт   | **К** | 10     | 3/2  | **1** | 2    |
| 4    | Шуруп  | С     | 11     | 4    | 2     | 1    |
| 5    | Гвоздь | С     | 10     | 2/3  | 1     | 1    |
| 6    | Винт   | **З** | 9      | 1    | **1** | 1    |
| 7    | Шуруп  | **З** | 18     | 7    | **2** | 2    |

```sql
SELECT Pno, Pname, Color, Weight,
	row_number()over(ORDER BY Weight) AS r1

	row_number()over(PARTITION BY Color ORDER BY Weight) AS r2
	
    row_number()over(PARTITION BY Pname ORDER BY Weight) AS r3
    # PARTITION BY - плавающее окно, группировка(Работаем с отдельными группами по очереди, не обращая внимание на другие)(В примере r2: К, С, З)
    
    # !row_number()over() AS r! - нельзя, неизвестно по чему сортировать
```

### Агрегатные функции

```sql
max(Weight)over(PARTITION BY Color) as m1

max(Weight)over(ORDER BY Pno) as m2 # ORDER BY - Накопительный вариант

sum(Weight)over(PARTITION BY Pname ORDER BY Weight) as m3
```

| Pno  | Pname  | Color | Weight | m1   | m2   | m3   |
| ---- | ------ | ----- | ------ | ---- | ---- | ---- |
| 1    | Гвоздь | К     | 14     | 15   | 14   | 24   |
| 2    | Гвоздь | К     | 15     | 15   | 15   | 39   |
| 3    | Винт   | К     | 10     | 15   | 15   | 19   |
| 4    | Шуруп  | С     | 11     | 11   | 15   | 11   |
| 5    | Гвоздь | С     | 10     | 11   | 15   | 10   |
| 6    | Винт   | З     | 9      | 18   | 15   | 9    |
| 7    | Шуруп  | З     | 18     | 18   | 18   | 29   |

#### Пример

Зарплаты

| id   | dt         | summa |
| ---- | ---------- | ----- |
| 1    | 2021-10-01 | 100   |
| 1    | 2021-10-01 | -10   |
| 1    | 2021-10-01 | -20   |
| 1    | 2021-10-02 | 100   |
| 1    | 2021-10-02 | 150   |
| 1    | 2021-10-03 | -100  |

Сумма на конец дня:

```sql
SELECT id, dt, 
		SUM(s)over(PARTITION BY id ORDER BY dt) as result
FROM (SELECT id, dt, SUM(summa) AS s
      FROM t
      GROUP BY id, dt)
```

Результат:

| id   | dt         | summa |
| ---- | ---------- | ----- |
| 1    | 2021-10-01 | 70    |
| 1    | 2021-10-02 | 320   |
| 1    | 2021-10-03 | 220   |

### Функции получения доступа

```sql
select ..
		lag(Weight)over(partition by Color
                    	order by Weight) as l1,
                    	lead(Weight)over(partition by Color
                    	order by Weight) as l2
from t
```

| Pno  | Pname  | Color | Weight | l1   | l2   |
| ---- | ------ | ----- | ------ | ---- | ---- |
| 1    | Гвоздь | **К** | 14     | 10   | 15   |
| 2    | Гвоздь | **К** | 15     | 14   | null |
| 3    | Винт   | **К** | 10     | null | 14   |
| 4    | Шуруп  | С     | 11     | 10   | null |
| 5    | Гвоздь | С     | 10     | null | 11   |
| 6    | Винт   | **З** | 9      | null | 18   |
| 7    | Шуруп  | **З** | 18     | 9    | null |

#### Пример

Люди на работе(1 - на рабочем месте, 2 - ушёл)

| id   | dt    | type |
| ---- | ----- | ---- |
| 1    | 9:00  | 1    |
| 1    | 10:00 | 2    |
| 1    | 10:15 | 1    |
| 1    | 19:00 | 2    |
| 2    | 9:00  | 1    |
| 3    | 10:00 | 2    |

Нужно получить

| id   | df    | dt    | type |
| ---- | ----- | ----- | ---- |
| 1    | 9:00  | 10:00 | 1    |
| 1    | 10:00 | 10:15 | 2    |
| 1    | 10:15 | 19:00 | 1    |
| 1    | 9:00  | 10:00 | `1   |
